#:kivy 2.2.1
#
ScreenManager:
  MenuScreen:
  ModeScreen:
  SelectionScreen:
  TrainingScreen:
  ResultScreen:
  SettingScreen:
  CustomScreen:
  ConfirmScreen:
<MenuScreen>:
  name: 'menu'
  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size

    FloatLayout:
      size_hint: 1, 0.3
      pos_hint: {'top': 1}

      Label:
        size: self.texture_size
        text: "Taichine" 
        font_name: 'fonts/SEVESBRG'
        font_size: self.height
        italic: True
        size_hint: 1, 0.8
        pos_hint: {'center_x': 0.5, 'center_y': 0.4}

      Label:
        size: self.texture_size
        text:"Your personal Tai Chi trainer" 
        font_name: 'fonts/KungfooFighter.otf'
        font_size: self.height * 0.5
        italic: True
        size_hint: 1, 0.3
        pos_hint: {'center_x': 0.5, 'center_y': 0.85}

    BoxLayout:
      canvas:
        Color:
          rgb: 0.2, 0.2, 0.2
        Rectangle:
          size: self.size
      orientation: 'vertical'
      padding: 10
      spacing: 10
      size_hint: 1, 0.7
      pos_hint: {'y': 0}

      Button:
        size_hint: 1, 0.25
        text_size: None, None
        font_size: self.height * 0.5
        text: 'Pose Selection'
        bold: True
        on_press:  
          root.manager.transition.direction = 'left'
          root.manager.current = 'mode'

      Button:
        size_hint: 1, 0.25
        text_size: None, None
        font_size: self.height * 0.5
        text: 'Custom Poses Upload'
        bold: True
        on_press:
          root.manager.transition.direction = 'left'
          root.manager.current = 'custom'

      Button:
        size_hint: 1, 0.25
        text_size: None, None
        font_size: self.height * 0.5
        text: 'Options'
        bold: True
        on_press:  
          root.manager.transition.direction = 'left'
          root.manager.current = 'setting'

      Button:
        size_hint: 1, 0.25
        text_size: None, None
        font_size: self.height * 0.5
        text: 'Quit'
        bold: True
        on_press: App.get_running_app().stop()

<ModeScreen>:
  name: 'mode'
  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size
    
    FloatLayout:
      size_hint: 1, 0.2
      pos_hint: {'top': 1, 'center_x': 0.5}

      Label:
        text: 'Choose your mode'
        color: 1, 1, 1, 1
        font_name: 'fonts/SEVESBRG'      
        size: self.texture_size
        font_size: self.height * 0.5
        pos_hint: {'center_y': 0.3, 'center_x': 0.5}
        bold: True

      Button:
        text: 'Back'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.1}
        bold: True
        on_press: 
          root.manager.transition.direction = 'right'
          root.manager.current = 'menu'
      
  BoxLayout:
    canvas:
      Color:
        rgb: 0.2, 0.2, 0.2
      Rectangle:
        size: self.size
    size_hint: 1, 0.8
    pos_hint: {'center_x': 0.5, 'y': 0}
    orientation: 'vertical'
    padding: 10
    spacing: 10

    Button:
      size_hint: 1, 0.5
      text_size: None, None
      font_size: self.height * 0.25
      text: "Yang Style 24-form Tai Chi Training"
      bold: True
      on_press: 
        root.manager.get_screen('selection').mode = 'integrated'
        root.manager.get_screen('selection').set_all()
        root.manager.transition.direction = 'left'
        root.manager.current = 'selection'

    Button:
      size_hint: 1, 0.5
      text_size: None, None
      font_size: self.height * 0.25
      text: "Uploaded Custom Poses"
      bold: True
      on_press: 
        root.manager.get_screen('selection').mode = 'custom'
        root.manager.get_screen('selection').set_all()
        root.manager.transition.direction = 'left'
        root.manager.current = 'selection'

<SelectionScreen>:
  name: 'selection'
  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size

    FloatLayout:
      size_hint: 1, 0.2
      pos_hint: {'top': 1, 'center_x': 0.5}

      Label:
        text: 'Training Selection'
        color: 1, 1, 1, 1
        font_name: 'fonts/SEVESBRG'      
        size: self.texture_size
        font_size: self.height * 0.5
        pos_hint: {'center_y': 0.3, 'center_x': 0.5}
        bold: True
      
      Button:
        text: 'Back'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.1}
        bold: True
        on_press: 
          root.manager.transition.direction = 'right'
          root.manager.current = 'mode'
    
    FloatLayout:
      canvas:
        Color:
          rgb: 0.8, 0.8, 0.8
        Rectangle:
          size: self.size
      size_hint: 1, 0.8
      pos_hint: {'y': 0, 'center_x': 0.5}

    ScrollView:
      size_hint: 1, 0.8

      GridLayout:
        id: menu_grid
        canvas:
          Color:
            rgb: 0.2, 0.2, 0.2
          Rectangle:
            size: self.size
        spacing: 10
        padding: 10
        cols: 1
        size_hint: 1, None
        pos_hint: {'bottom': 0, 'center_x': 0.5}

<TrainingScreen>:
  name: 'training'
  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size
    
    FloatLayout:
      size_hint: 1, 0.2
      pos_hint: {'top': 1, 'center_x': 0.5}

      Label:
        id: score_label
        text: 'Press Start to Begin'
        color: 1, 1, 1, 1
        font_name: 'fonts/SEVESBRG'      
        size: self.texture_size
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.3, 'center_x': 0.5}
        bold: True

      Button:
        text: 'Back'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.1}
        on_press: 
          root.remove_user_pic()
          root.manager.transition.direction = 'right'
          root.manager.current = 'selection'

      Button:
        id: start_button
        text: 'Start'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.9}
        on_press: root.start_stop_button()

    GridLayout:
      canvas:
        Color:
          rgb: 0.8, 0.8, 0.8
        Rectangle:
          size: self.size
      cols: 3
      size_hint: 1, 0.8
      pos_hint: {'y': 0}
      padding: 10
      spacing: 10

      TrimmedCamera:
        id: camera
        resolution: (640, 480)
        play: True
        allow_stretch: True
        keep_ration: True

      RelativeLayout:
        id: skeleton_canvas
        canvas:
          Color:
            rgb: 0.0, 0.0, 0.0
          Rectangle:
            size: self.size
            pos: (0,0)

      Image:
        id: reference_image
        allow_stretch: True
        keep_ration: True
                
<ResultScreen>:
  name: 'result'
  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size
    
    FloatLayout:
      size_hint: 1, 0.2
      pos_hint: {'top': 1, 'center_x': 0.5}

      Label:
        text: 'Results!'
        color: 1, 1, 1, 1
        font_name: 'fonts/SEVESBRG'      
        size: self.texture_size
        font_size: self.height * 0.5
        pos_hint: {'center_y': 0.3, 'center_x': 0.5}
        bold: True

      Label:
        text: 'Press Back to Go back to Mode Selection'
        color: 1, 1, 1, 1
        font_name: 'fonts/KungfooFighter.otf'     
        size: self.texture_size
        font_size: self.height * 0.2
        pos_hint: {'center_y': 0.7, 'center_x': 0.5}

      Button:
        text: 'Back'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.1}
        on_press: 
          root.manager.transition.direction = 'right'
          root.manager.current = 'mode'
  
    BoxLayout:
      canvas:
        Color:
          rgb: 0.8, 0.8, 0.8
        Rectangle:
          size: self.size
      orientation: 'vertical'
      size_hint: 1, 0.8
      pos_hint: {'y': 0, 'center_x': 0.5}
      padding: 40
      spacing: 20

      Label:
        id: average_score
        color: 0, 0, 0, 1
        font_name: 'fonts/Aller' 
        size: self.texture_size
        font_size: self.height * 0.3
        bold: True

      Label:
        id: total_time
        color: 0, 0, 0, 1
        font_name: 'fonts/Aller'
        size: self.texture_size
        font_size: self.height * 0.3
        bold: True
      
      Label:
        id: tips_label
        color: 0, 0, 0, 1
        font_name: 'fonts/Aller'
        text_size: self.size
        size: self.texture_size
        font_size: self.height * 0.2
        bold: True

<SettingScreen>:
  name: 'setting'
  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size

    FloatLayout:
      size_hint: 1, 0.2
      pos_hint: {'top': 1, 'center_x': 0.5}

      Label:
        text: 'Setting'
        color: 1, 1, 1, 1
        font_name: 'fonts/SEVESBRG'      
        size: self.texture_size
        font_size: self.height * 0.5
        pos_hint: {'center_y': 0.3, 'center_x': 0.5}
        bold: True

      Button:
        text: 'Back'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.1}
        bold: True
        on_press: 
          root.set_value()
          root.manager.transition.direction = 'right'
          root.manager.current = 'menu'        
    
    GridLayout:
      canvas:
        Color:
          rgb: 0.8, 0.8, 0.8
        Rectangle:
          size: self.size
      cols: 2
      rows: 3
      size_hint: 1, 0.8
      pos_hint: {'center_x': 0.5, 'bottom': 0}
      padding: 50

      Label:
        id: tolerance_label
        text: 'Tolerance: ' + str(int(tolerance_slider.value)) + ' degrees'
        color: 0, 0, 0, 1
        size_hint: 0.8, 0.2
        font_size: self.width * 0.1
        width: 80

      Slider:
        id: tolerance_slider
        min: 5
        max: 15
        value: 5
        step: 1
        orientation: 'horizontal'

      Label:
        id: preparation_label
        text: 'Preparation Time: ' + str(int(preparation_slider.value)) + 's'
        color: 0, 0, 0, 1
        size_hint: 0.8, 0.2
        font_size: self.width * 0.1
        width: 80

      Slider:
        id: preparation_slider
        min: 5
        max: 20
        value: 15
        step: 1
        orientation: 'horizontal'

      Label:
        id: move_on_label
        text: 'Move-on Time: ' + str(int(move_on_slider.value)) + 's'
        color: 0, 0, 0, 1
        size_hint: 0.8, 0.2
        font_size: self.width * 0.1
        width: 80

      Slider:
        id: move_on_slider
        min: 1
        max: 15
        value: 5
        step: 1
        orientation: 'horizontal'

<CustomScreen>:
  name:'custom'
  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size

    FloatLayout:
      size_hint: 1, 0.2
      pos_hint: {'y': 0.8, 'center_x': 0.5}

      Label:
        text: 'Upload your pose'
        color: 1, 1, 1, 1
        font_name: 'fonts/SEVESBRG'      
        size: self.texture_size
        font_size: self.height * 0.5
        pos_hint: {'center_y': 0.3, 'center_x': 0.5}
        bold: True
      
      Button:
        text: 'Back'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.1}
        bold: True
        on_press: 
          root.manager.transition.direction = 'right'
          root.manager.current = 'menu'

    BoxLayout:
      canvas:
        Color:
          rgb: 0.8, 0.8, 0.8
        Rectangle:
          size: self.size      
      orientation: "vertical"
      size_hint: 1, 0.8
      pos_hint: {'y': 0, 'center_x': 0.5}
      
      canvas.before:
        Rectangle:
          pos: self.pos
          size: self.size
          Color:
            rgba: 1, 1, 1, 1
      
      padding: 50
      spacing: 20

      Label:
        text: "Please Upload a Custom Pose!"
        font_size: 32
        color: 0, 0, 0, 1
      
      FloatLayout:
        canvas:
          Color:
            rgb: 1, 1, 1
          Rectangle:
            size: self.size
            pos : self.pos
        size_hint: 0.5, 0.5
        pos_hint: {'center_x': 0.5, 'y': 0}

        Button:
          id: upload_button
          size_hint: 1, 1
          pos_hint: {'center_x': 0.5, 'center_y': 0.5}
          # background_normal: 'icons/file-upload_white.png'
          on_press: 
            # root.manager.current = "selection_screen"
            root.select_file()
            root.manager.current = 'confirm' if root.cancel == False else 'custom'
            root.manager.transition.direction = 'right'
                  
        Image:
          id: button_image
          size_hint: 1, 1
          pos_hint: {'center_x': 0.5, 'center_y': 0.5}
          source: "icons/file-upload_white.png"

<ConfirmScreen>:
  name:'confirm'

  FloatLayout:
    canvas:
      Color:
        rgb: 0.6, 0.8, 0.8
      Rectangle:
        size: self.size

    FloatLayout:
      size_hint: 1, 0.2
      pos_hint: {'y': 0.8, 'center_x': 0.5}

      Label:
        text: 'Confirm'
        color: 1, 1, 1, 1
        font_name: 'fonts/SEVESBRG'      
        size: self.texture_size
        font_size: self.height * 0.5
        pos_hint: {'center_y': 0.3, 'center_x': 0.5}
        bold: True
        background_color: 0, 1, 0, 1
      
      Button:
        text: 'Back'
        color: 1, 1, 1, 1
        size_hint: 0.15, 0.8
        font_size: self.height * 0.35
        pos_hint: {'center_y': 0.5, 'center_x': 0.1}
        bold: True
        on_press: 
          root.manager.transition.direction = 'right'
          root.manager.current = 'custom'
          

    FloatLayout:
      canvas:
        Color:
          rgb: 0.8, 0.8, 0.8
        Rectangle:
          size: self.size  
      orientation: "vertical"
      size_hint: 1, 0.8
      pos_hint: {'y': 0, 'center_x': 0.5}
      
      canvas.before:
        Color:
          rgba: 1, 1, 1, 1
        Rectangle:
          pos: self.pos
          size: self.size


      # Image:
      #   source: confirm_selection
      #   size_hint: 0.3, 0.3
      #   pos_hint: {'center_x': 0.5, 'center_y': 0.2}
      GridLayout:
        id: grid_layout
        rows: 1
        orientation: 'lr-tb'
        pos_hint: {'center_x': 0.50,'center_y': 0.55}
        size_hint: 1.0, 0.6
        # canvas:
        #   Color:
        #     rgb: 0.0, 0.0, 1.0
        #   Rectangle:
        #     size: self.size
        #     pos: self.pos
          

      Button:
        id: confirm_button
        text: "Confirm"
        size_hint: 0.1, 0.1
        pos_hint: {'center_x': 0.5, 'center_y': 0.1}
        background_color: 0,1,0,1
        on_press: 
          root.confirmed()
          root.manager.transition.direction = 'left'
          root.manager.current = 'custom'

<PoseSequenceItem@RelativeLayout>:
  
  # RelativeLayout:
   
  Image:
    id: pose_image
    source: 'icons/no_image_96.png'
    # size_hint: 1.0, 1.0
    width: self.parent.width
    height: self.parent.height
    # pos_hint: {'center_x': 0.5, 'center_y': 0.5}
    pos: self.parent.pos
    # allow_stretch: True
    # keep_ratio: False
    

    Button:
      id: exit_button
      # right: root.right
      # size_hint: 0.075, 0.075
      # 10000 - 100000
      # size_hint: self.parent.width / 1000, self.parent.height / 25000
      # width: self.parent.width / 10
      # height: self.parent.height / 25
      background_color: 1,1,1,1
      # pos: self.parent.pos
      # pos: self.parent.x + 10, self.parent.y
      x: self.parent.right - self.width
      y: self.parent.top - self.height
      # on_press: root.exit_button(self.parent.parent.parent.parent.parent.parent.posesList)
      on_press: root.parent.parent.parent.parent.exit_button(self.parent.source)

      Image:
        id:exit_button_image
        source: 'icons/exit-icon.png'
        width: self.parent.width
        height: self.parent.height
        # center_x: self.parent.center_x
        # center_y: self.parent.center_y
        pos: self.parent.pos
    # The labels needs to be placed here otherwise they all stack on top of each other
    # in first grid cell
    Label:
      id: image_label
      text: 'No Image Selected'
      center_x: self.parent.center_x
      y: self.parent.top - self.height
      # width: self.parent.width
      color: 0, 0, 0, 1
      background_color: 0, 0, 0, 0

    Button:
      id: left_button
      # pos_hint: {'right': 0.5, 'top': 0.2}

      # size_hint: self.parent.width / 1000, self.parent.height / 25000
      # size_hint: self.parent.width / 2048, self.parent.height / 2048
      x: self.parent.center_x - self.width
      y: self.parent.y
      background_color: 255,255,255,1
      # on_press: root.left_button()
      on_press: root.parent.parent.parent.parent.left_button(self.parent.source)

      Image:
        id:left_button_image
        source: 'icons/button-left.png'
        width: self.parent.width
        height: self.parent.height
        # center_x: self.parent.center_x
        # center_y: self.parent.center_y
        pos: self.parent.pos

    Button:
      id: right_button
      # size_hint: self.parent.width / 4, self.parent.height / 4
      # pos_hint: {'right': 0.8, 'top': 0.2}

      # pos_hint: {'x': 3, 'y': 3}
      # size_hint: self.parent.width / 1000, self.parent.height / 25000
      x: self.parent.center_x + self.width
      y: self.parent.y
      # size_hint: self.parent.width / 2048, self.parent.height / 2048
      background_color: 255,255,255,1
      # on_press: root.right_button()
      on_press: root.parent.parent.parent.parent.right_button(self.parent.source)

      Image:
        id:right_button_image
        source: 'icons/button-right.png'
        width: self.parent.width
        height: self.parent.height
        # center_x: self.parent.center_x
        # center_y: self.parent.center_y
        pos: self.parent.pos

<PoseItem>:
  canvas:
    Color:
      rgb: 0.3, 0.3, 0.3, 1
    Rectangle:
      pos: self.pos
      size: self.size
  orientation: 'horizontal'
  size_hint: 1, None
  height: 150
  on_press: 
    current_screen = root.parent.parent.parent.parent
    current_screen.manager.get_screen('training').mode = current_screen.mode
    current_screen.manager.get_screen('training').set_reference_image(root.mode, root.id, '1')
    current_screen.manager.transition.direction = 'left'
    current_screen.manager.current = 'training'
    current_screen.manager.get_screen('training').set_preparation_countdown()
    current_screen.manager.get_screen('training').ids['start_button'].text = 'Start'
    current_screen.manager.get_screen('training').ids['score_label'].text = 'Press Start to Begin'
    
  Image:
    size_hint: 0.15, 1
    source: root.image

  Label:
    size_hint: 0.85, 1
    text: root.label
    font_size: self.height * 0.5
    bold: True
    font_name: 'fonts/Aller'
